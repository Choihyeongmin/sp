
# 시스템 프로그래밍 Assignment #4

**학과:** 디지털미디어학과  
**학번:** 202021128  
**이름:** 최형민

---

## 주제 선정 및 요구사항 분석

이 프로젝트는 차량 내 ECU(전자제어장치) 간 통신을 모사한 시스템으로, **엑셀 페달을 밟았을 때 속도 증가, 속도 제한, 페달을 밟지 않았을 때 속도 감소**의 시나리오를 기반으로 합니다. GPIO 출력만으로 구성된 단순한 구조가 아니라, **명령 송수신 구조, 상태 기반 FSM, ACK 기반 신뢰성 확보, 속도 감속 시나리오** 등을 포함한 통신 시스템으로 설계하였습니다.

### 요구사항

1. 송신측에서 제어 명령(가속)을 일정한 포맷으로 송신  
2. 수신측은 명령을 파싱해 FSM 상태 갱신 및 ACK 송신  
3. 일정 시간 명령이 없으면 자동 감속 시나리오 수행  
4. 모든 데이터 송수신은 GPIO 2쌍(DATA+CLK)으로 비트 단위 전송  

---

## 통신 기법 및 구조 설계

### GPIO 핀 매핑

| 기능        | TX (송신 Pi) | RX (수신 Pi) |
|-------------|--------------|--------------|
| 데이터 송신 | GPIO 4 (out) | GPIO 17 (in) |
| 클럭 송신   | GPIO 27 (out)| GPIO 22 (in) |
| 데이터 응답 | GPIO 6 (in)  | GPIO 5 (out) |
| 클럭 응답   | GPIO 20 (in) | GPIO 21 (out)|

### 프레임 구조 (4바이트)

- Byte 0: 시작 (0xAA)  
- Byte 1: 명령 (0x01: ACCEL)  
- Byte 2: 값 (예: 10)  
- Byte 3: 체크섬 (XOR of Byte0~2)

### ACK 응답 구조

- Byte 0: 시작 (0x55)  
- Byte 1: 현재 속도 (0~100)  
- Byte 2: 상태 코드 (IDLE, ACCEL, DECEL, LIMITED)  
- Byte 3: 체크섬  

---

## SW 설계 및 동작 흐름

### 전체 구조 개요

- **TX 측:** 사용자의 입력을 받아 명령 전송  
- **RX 측:** 명령 수신 → FSM 상태 갱신 → 응답 송신  
- **Full-Duplex 핀 구성**이지만 실제 동작은 논리적 Half-Duplex  

### 데이터 흐름 요약

1. TX 앱: Enter 입력 → 명령 프레임 생성 및 전송  
2. TX 드라이버: 4바이트 프레임을 비트 단위로 송신  
3. RX 드라이버: 1비트씩 수신 → FSM 상태 갱신 및 ACK 예약  
4. RX: Workqueue 통해 ACK 전송  
5. TX 드라이버: 응답 수신 시 SIGIO 발생  
6. TX 앱: ACK 수신 및 출력

### 자원 최적화 및 신뢰성

- `gpiod_*` API 사용 (consumer.h 기반)  
- 인터럽트 기반 수신 및 Workqueue 활용  
- 비정상 프레임 필터링 위한 시작 바이트/체크섬 검증  
- 감속 로직: `delayed_work` 기반, 2초 무응답 시 속도 감소  

---

## 구성 파일 설명

### `tx_app.c`

- Enter 입력 시 명령 전송  
- SIGIO 기반 응답 수신 처리  

### `tx_drv.c`

- write() → send_frame() 실행  
- 수신 시 인터럽트 → SIGIO 발생  

### `rx_drv.c`

- 인터럽트 기반 수신 처리  
- 유효한 명령이면 FSM 상태 갱신  
- Workqueue로 ACK 응답 송신 예약  
- 감속 로직: `decay_work_fn()` 1초 주기로 실행  

### `rx_app.c`

- 디바이스를 open하여 감속 로직 유지  
- 실제 입출력 없음, 유지용  

---

## 동작 검증 및 성능 분석

- 속도 증가: +10씩 증가, 최대 100  
- 상태 코드 전이: ACCEL → LIMITED  
- 속도 감소: 무응답 시 -10씩 감소, 최종적으로 IDLE 도달  
- 실시간 인터럽트 기반 응답 수신 확인  

---

## 통신 성능 분석

### 통신 속도

- 각 비트 전송 약 220ms  
- 한 프레임 송수신 시 약 14초 소요  

### 신뢰성 확보

- 시작 바이트 및 체크섬으로 유효성 검증  
- ACK로 응답 송신 여부 확인 → 양방향 보장  

### 자원 효율

- IRQ 기반 수신 처리  
- Workqueue로 커널 안정성 확보  
- Polling 없이 작동 → CPU 사용량 최소화  

---

## 기존 프로토콜과 비교

| 항목 | 사용자 구현 | I2C | SPI | UART |
|------|--------------|-----|-----|------|
| 라인 수 | 4개 | 2개 | 4개 | 2개 |
| 동기/비동기 | 동기 | 동기 | 동기 | 비동기 |
| 통신 방식 | Half-Duplex | Master-Slave | Full-Duplex | 비동기 직렬 |
